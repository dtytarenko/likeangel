(()=>{"use strict";let e=function(e,t){this.$el=e,this.$value=e.querySelector(".wcus-search-control__value"),this.$query=e.querySelector(".wcus-search-control__query"),this.$results=e.querySelector(".wcus-search-control__results"),this.disabled=!1,this.params=t||{},this.timerId=null,this.initEvents()};function t(t,s){return new e(t,s)}function s(e){if(!e.success)return[];let t=[];return e.data.forEach((function(e){let s={value:e.SettlementStreetRef?e.SettlementStreetRef:e.Ref,name:e.Present,disabled:!1,"entity-name":e.MainDescription||e.SettlementStreetDescription,area:e.Area,region:e.Region};e.DeliveryCity&&(s["delivery-city"]=e.DeliveryCity),t.push(s)})),t}e.prototype.initEvents=function(){let e=this;e.$query.addEventListener("input",(function(){e.isDisabled()||(e.timerId&&clearTimeout(e.timerId),e.timerId=setTimeout((function(){e.$query.value.length>=2&&(e.$results.classList.remove("active"),"function"==typeof e.params.searchCallback?e.params.searchCallback(e):e.params.searchUrl?e.searchUsingUrl():console.error("Invalid search mapping."))}),500))})),e.$query.addEventListener("keydown",(function(t){e.isDisabled()&&t.preventDefault()})),e.$results.addEventListener("click",(function(t){t.target.classList.contains("wcus-search-control__result")&&(t.stopImmediatePropagation(),t.target.classList.contains("disabled")||(e.preventSearch=!0,e.$query.value=t.target.innerHTML,e.$value.value=t.target.dataset.value,e.$results.classList.remove("active"),"function"==typeof e.params.onSelect&&e.params.onSelect(t.target)))}))},e.prototype.searchUsingUrl=function(){let e=this;if(void 0===window.jQuery)return void console.error("AJAX error: jQuery library not found");e.disable();let t=window.jQuery,s=e._mapRequestData(e.params.requestData||{});t.ajax({method:"POST",url:e.params.searchUrl,data:Object.assign({search_query:e.$query.value},s),success:function(t){e.enable(),!t.success&&t.exception&&console.error(t.exception);let s="",i=e.getResponseData(t);i.length&&(i.forEach((function(e){let t="";for(let s in e)e.hasOwnProperty(s)&&-1===["disabled","value","name"].indexOf(s)&&(t+="data-"+s+'="'+e[s]+'" ');s+='<div class="wcus-search-control__result'+(e.disabled?" disabled":"")+'" data-value="'+e.value+'"'+(t.length?" "+t:"")+">"+e.name+"</div>"})),e.$results.innerHTML=s,e.$results.classList.add("active"))}})},e.prototype.getResponseData=function(e){return"function"==typeof this.params.responseMapper?this.params.responseMapper(e):e},e.prototype.isDisabled=function(){return this.disabled},e.prototype.disable=function(){this.disabled=!0,this.$query.classList.add("disabled")},e.prototype.enable=function(){this.disabled=!1,this.$query.classList.remove("disabled")},e.prototype.getValue=function(){return this.$value.value},e.prototype.setValue=function(e){this.$value.value=e},e.prototype.getTitle=function(){return this.$query.value},e.prototype.setTitle=function(e){this.$query.value=e},e.prototype._mapRequestData=function(e){let t={};for(let s in e)e.hasOwnProperty(s)&&("function"==typeof e[s]?t[s]=e[s]():t[s]=e[s]);return t};class i{constructor(e,t,s){e&&(this._$=s,this._$el=s(e),this._params=t||{},this._initSelect2(),this._initEvents())}setValue(e){this._$el&&this._$el.val(e).trigger("change.select2")}getValue(){return this._$el.val()}setOptions(e){let t="";this._params.placeholder&&e.unshift({value:"",name:this._params.placeholder}),e.forEach((e=>{t+=`<option value="${e.value}">${e.name}</option>`})),this.setOptionsHtml(t),this._hasMirror()&&this._getMirror().setOptionsHtml(t),this._params.ajax&&this._params.ajax.target().setOptions([])}setOptionsHtml(e){this._$el&&this._$el.html(e)}_initSelect2(){let e=this;"function"==typeof this._$.fn.select2&&this._$el.select2({sorter:function(t){return t.sort((function(s,i){let n=e._$(".select2-search__field");if(0===n.length||""===n.val())return t;let a=s.text.toLowerCase(),l=i.text.toLowerCase(),c=n.val().toLowerCase();return a.indexOf(c)<l.indexOf(c)?-1:a.indexOf(c)>l.indexOf(c)?1:0})),t},language:{noResults:function(){return wc_ukr_shipping_globals.i10n.not_found}}})}_initEvents(){let e=this;e._$el.on("change",(function(){e._hasMirror()&&e._getMirror().setValue(e.getValue()),e._params.ajax&&e._getAjaxData()}))}_getAjaxData(){let e=this;e._trigger("beforeRequest");let t={action:e._params.ajax.action,_token:wc_ukr_shipping_globals.nonce,value:e.getValue()};"function"==typeof e._params.ajax.params&&(t=Object.assign(t,e._params.ajax.params())),e._$.ajax({method:"POST",url:wc_ukr_shipping_globals.ajaxUrl,data:t,dataType:"json",success:function(t){e._trigger("response",{data:t.data}),t.success&&e._params.ajax.target().setOptions(t.data.items)},error:function(t,s,i){e._trigger("response"),console.error(`WCUS Error: ${t.status} ${t.statusText}`)}})}_hasMirror(){return"function"==typeof this._params.mirror}_getMirror(){return this._params.mirror()}_trigger(e,t){this._params.events&&"function"==typeof this._params.events[e]&&this._params.events[e](this,t||{})}}const n={init:function(e){this.$=e,this.$differentShipping=this.$("#ship-to-different-address-checkbox")},setLoadingState(){this.$(".wc-ukr-shipping-np-fields").addClass("wcus-state-loading")},unsetLoadingState(){this.$(".wc-ukr-shipping-np-fields").removeClass("wcus-state-loading")},cityRef(){let e=this.getShippingType();return this.isAddressShipping()&&parseInt(wc_ukr_shipping_globals.apiAddressEnable)?this.$("#wcus_np_"+e+"_settlement_ref").val():this.$("#wcus_np_"+e+"_city").val()},isAddressShipping(){let e=this.getShippingType();return this.$("#wcus_np_"+e+"_custom_address_active").prop("checked")?1:0},getShippingType(){return this.$differentShipping.length&&this.$differentShipping.prop("checked")?"shipping":"billing"}},a={init:function(e){this.$=e},calculateShipping:function(){n.cityRef()&&(0,this.$)(document.body).trigger("update_checkout")}};function l(e){return Object.assign({events:{beforeRequest:function(e){n.setLoadingState()},response:function(e){n.unsetLoadingState()}},i10n:{noResult:wc_ukr_shipping_globals.i10n.not_found}},e)}!function(e){let c,r=document.getElementById("ship-to-different-address-checkbox"),o=null;n.init(e),a.init(e);let _=function(){let t=e(".shipping_method").length>1?e(".shipping_method:checked").val():e(".shipping_method").val();return t&&t.match(/^nova_poshta_shipping.+/i)},p=function(){return _()?(r&&r.checked?e("#wcus_shipping_phone_field").show():e("#wcus_shipping_phone_field").hide(),o.length&&o[0].checked?void(r&&r.checked?(e("#wcus_billing_middlename_field").hide(),e("#wcus_shipping_middlename_field").show()):(e("#wcus_billing_middlename_field").show(),e("#wcus_shipping_middlename_field").hide())):(e("#wcus_billing_middlename_field").hide(),void e("#wcus_shipping_middlename_field").hide())):(e("#wcus_billing_middlename_field").hide(),e("#wcus_shipping_middlename_field").hide(),void e("#wcus_shipping_phone_field").hide())};e((function(){e("#wcus_np_billing_fields").css("display","none"),e("#wcus_np_shipping_fields").css("display","none"),e(document.body).bind("update_checkout",(function(e,t){n.setLoadingState()})),e(document.body).bind("updated_checkout",(function(t,s){c=e("#billing_country").length?e("#billing_country").val():"UA",_()?r&&r.checked?e("#wcus_np_shipping_fields").css("display","block"):e("#wcus_np_billing_fields").css("display","block"):(e("#wcus_np_billing_fields").css("display","none"),e("#wcus_np_shipping_fields").css("display","none")),_()&&1===parseInt(wc_ukr_shipping_globals.disableDefaultBillingFields)?(e("#billing_address_1_field").css("display","none"),e("#billing_address_2_field").css("display","none"),e("#billing_city_field").css("display","none"),e("#billing_state_field").css("display","none"),e("#billing_postcode_field").css("display","none"),e("#shipping_address_1_field").css("display","none"),e("#shipping_address_2_field").css("display","none"),e("#shipping_city_field").css("display","none"),e("#shipping_state_field").css("display","none"),e("#shipping_postcode_field").css("display","none")):(e("#billing_address_1_field").css("display","block"),e("#billing_address_2_field").css("display","block"),e("#billing_city_field").css("display","block"),e("#billing_state_field").css("display","block"),e("#billing_postcode_field").css("display","block"),e("#shipping_address_1_field").css("display","block"),e("#shipping_address_2_field").css("display","block"),e("#shipping_city_field").css("display","block"),e("#shipping_state_field").css("display","block"),e("#shipping_postcode_field").css("display","block")),p(),n.unsetLoadingState()})),e("body").on("change",'input[name="payment_method"]',(function(){a.calculateShipping()})),function(){o=e(".j-wcus-np-custom-address"),o.length&&o.on("click",(function(){let t=document.getElementById(this.dataset.relationSelect);t&&(t.checked=this.checked),this.checked?(e(".j-wcus-warehouse-block").slideUp(400),e(".j-wcus-np-custom-address-block").slideDown(400),p()):(e(".j-wcus-warehouse-block").slideDown(400),e(".j-wcus-np-custom-address-block").slideUp(400),p()),a.calculateShipping()}));let t=function(t){t.checked?(e("#wcus_np_shipping_fields").css("display","block"),e("#wcus_np_billing_fields").css("display","none")):(e("#wcus_np_shipping_fields").css("display","none"),e("#wcus_np_billing_fields").css("display","block"))};r&&(t(r),r.addEventListener("click",(function(){t(this)})))}(),function(e){let t,s,c,r,o,_;t=new i(document.getElementById("wcus_np_billing_area"),l({mirror:()=>s,ajax:{action:"wcus_api_v2_get_cities",target:()=>c},placeholder:wc_ukr_shipping_globals.i10n.placeholder_area}),e),s=new i(document.getElementById("wcus_np_shipping_area"),l({mirror:()=>t,ajax:{action:"wcus_api_v2_get_cities",target:()=>r},placeholder:wc_ukr_shipping_globals.i10n.placeholder_area}),e),c=new i(document.getElementById("wcus_np_billing_city"),l({mirror:()=>r,ajax:{action:"wcus_api_v2_get_warehouses",target:()=>o},events:{beforeRequest:function(e){n.setLoadingState(),a.calculateShipping()},response:function(e,t){n.unsetLoadingState()}},placeholder:wc_ukr_shipping_globals.i10n.placeholder_city}),e),r=new i(document.getElementById("wcus_np_shipping_city"),l({mirror:()=>c,ajax:{action:"wcus_api_v2_get_warehouses",target:()=>_},events:{beforeRequest:function(e){n.setLoadingState(),a.calculateShipping()},response:function(e,t){n.unsetLoadingState()}},placeholder:wc_ukr_shipping_globals.i10n.placeholder_city}),e),o=new i(document.getElementById("wcus_np_billing_warehouse"),l({mirror:()=>_,placeholder:wc_ukr_shipping_globals.i10n.placeholder_warehouse}),e),_=new i(document.getElementById("wcus_np_shipping_warehouse"),l({mirror:()=>o,placeholder:wc_ukr_shipping_globals.i10n.placeholder_warehouse}),e)}(e);let u=document.getElementById("wcus_np_billing_settlement_control"),d=document.getElementById("wcus_np_billing_street_control"),g=document.getElementById("wcus_np_shipping_settlement_control"),h=document.getElementById("wcus_np_shipping_street_control"),m=null,f=null;if(!u)return;let y=new t(u,{searchUrl:wc_ukr_shipping_globals.ajaxUrl,requestData:{action:"wc_ukr_shipping_search_settlements",body:{token:wc_ukr_shipping_globals.nonce}},responseMapper:s,onSelect:function(e){m&&(m.setValue(y.getValue()),m.setTitle(y.getTitle()),document.getElementById("wcus_np_shipping_settlement_name").value=e.dataset.entityName,document.getElementById("wcus_np_shipping_settlement_area").value=e.dataset.area,document.getElementById("wcus_np_shipping_settlement_region").value=e.dataset.region),document.getElementById("wcus_np_billing_settlement_name").value=e.dataset.entityName,document.getElementById("wcus_np_billing_settlement_area").value=e.dataset.area,document.getElementById("wcus_np_billing_settlement_region").value=e.dataset.region,a.calculateShipping()}}),w=new t(d,{searchUrl:wc_ukr_shipping_globals.ajaxUrl,requestData:{action:"wc_ukr_shipping_search_settlement_streets",ref:function(){return y.getValue()},body:{token:wc_ukr_shipping_globals.nonce}},responseMapper:s,onSelect:function(e){f&&(f.setValue(w.getValue()),f.setTitle(w.getTitle()),document.getElementById("wcus_np_shipping_street_name").value=e.dataset.entityName),document.getElementById("wcus_np_billing_street_name").value=e.dataset.entityName}});g&&(m=new t(g,{searchUrl:wc_ukr_shipping_globals.ajaxUrl,requestData:{action:"wc_ukr_shipping_search_settlements",body:{token:wc_ukr_shipping_globals.nonce}},responseMapper:s,onSelect:function(e){y.setValue(m.getValue()),y.setTitle(m.getTitle()),document.getElementById("wcus_np_billing_settlement_name").value=e.dataset.entityName,document.getElementById("wcus_np_billing_settlement_area").value=e.dataset.area,document.getElementById("wcus_np_billing_settlement_region").value=e.dataset.region,document.getElementById("wcus_np_shipping_settlement_name").value=e.dataset.entityName,document.getElementById("wcus_np_shipping_settlement_area").value=e.dataset.area,document.getElementById("wcus_np_shipping_settlement_region").value=e.dataset.region,a.calculateShipping()}})),h&&(f=new t(h,{searchUrl:wc_ukr_shipping_globals.ajaxUrl,requestData:{action:"wc_ukr_shipping_search_settlement_streets",ref:function(){return m.getValue()},body:{token:wc_ukr_shipping_globals.nonce}},responseMapper:s,onSelect:function(e){w.setValue(f.getValue()),w.setTitle(f.getTitle()),document.getElementById("wcus_np_billing_street_name").value=e.dataset.entityName,document.getElementById("wcus_np_shipping_street_name").value=e.dataset.entityName}}))}))}(jQuery)})();